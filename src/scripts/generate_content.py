#!/usr/bin/env python3
"""
コンテンツ生成スクリプト - 7日以内最新情報 & 引用元必須版

Design Guidelines:
- 絵文字禁止
- 紫色系禁止
- AIっぽい表現禁止
- 7日以内の最新情報のみ使用
- 引用元・参考文献を必ず記載
"""
import asyncio
import argparse
import json
import re
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))
from lib.gemini_client import GeminiClient
from lib.timezone import format_date, now_jst


# デザインガイドラインを定数として定義
DESIGN_GUIDELINES = """
【デザインガイドライン - 必ず遵守してください】

■ 絶対禁止事項
1. 絵文字の使用禁止 - タイトル、見出し、本文すべてで絵文字を使わないでください
2. AIっぽい表現の禁止:
   - 「革新的」「画期的」「驚くべき」などの陳腐な表現
   - 過度な感嘆符（！）の使用
   - 「さあ、始めましょう」などの押し付けがましい表現
   - 「〜してみてはいかがでしょうか」などの回りくどい表現

■ タイトルルール
- 具体的で価値が伝わるタイトル
- 数字を効果的に使用（例: 「5つの方法」「3つのポイント」）
- 60文字以内
- 絵文字は絶対に使用しない

■ 見出しルール
- H2: 主要セクションの区切り（5-7個程度）
- H3: サブトピック
- 見出しだけで記事の内容が把握できるように

■ 本文ルール
- 1段落は3-5文程度
- 専門用語は初出時に説明
- 箇条書きを効果的に使用
- 具体例やデータを必ず含める
- 根拠のない主張は避ける

■ トーン
- 専門的だが親しみやすい
- 押し付けがましくない
- 読者を尊重した表現
- 科学的・論理的なアプローチ
"""

# 高品質記事のための追加ガイドライン（5倍以上の充実した内容）
QUALITY_GUIDELINES = """
【高品質記事のための必須要件 - 5倍版】

■ 記事ボリューム要件（必須）
- **最低文字数: 20,000文字以上**（従来の5倍）
- H2見出し: 12-18個
- H3サブ見出し: 各H2に3-5個
- 各セクション: 1000-1500字の充実したボリューム
- 具体例・事例: 最低20個以上
- データ・統計: 最低25個以上

■ 読者価値の最大化
1. 問題解決型アプローチ
   - 読者が抱える具体的な課題を複数の角度から明確にする
   - 段階的で実践可能な解決策を提示する
   - 「なぜ」と「どうやって」を詳細に説明する
   - 初心者向け・中級者向け・上級者向けのアドバイスを分ける

2. 具体性の担保（徹底）
   - 抽象的な説明の後に必ず具体例を5つ以上示す
   - 数値データ、統計、調査結果を積極的に引用（ソース明記）
   - 「多くの」「さまざまな」などの曖昧な表現は絶対禁止
   - 具体的な企業名、サービス名、専門家名を挙げる
   - 実際の成功事例と失敗事例を両方紹介

3. 信頼性の確保
   - すべての主張に根拠（ソース）を明記
   - 専門家の見解や研究結果を複数引用
   - 反論や異なる視点も公平に紹介
   - 最新の調査データ（7日以内）を優先的に使用

■ 読者をワクワクさせる要素（必須）

1. ストーリーテリング
   - 記事冒頭で読者を引き込む「フック」を入れる
   - 実在の人物や企業のドラマチックなストーリーを紹介
   - 「before → after」の変化を鮮明に描写する
   - 読者が主人公として体験できるような語りかけ

2. 驚きと発見（Aha!モーメント）
   - 「意外と知られていない事実」を各セクションに1つ以上
   - 「常識を覆すデータ」を効果的に配置
   - 「なるほど」と思わせる洞察を提供
   - 読者の予想を超える情報を盛り込む

3. 感情に訴える要素
   - 課題に対する共感を冒頭で示す
   - 成功者の感動的なエピソードを含める
   - 読者の不安や悩みに寄り添う表現
   - 希望や期待を持たせる未来像を描く

4. インタラクティブ要素
   - 読者への問いかけを5箇所以上に配置
   - 「あなたならどうしますか?」と考えさせる
   - 自己診断的な要素（チェックリストなど）
   - 読み終わった後にすぐ実践したくなる内容

5. 読みやすさと没入感
   - 短い文と長い文のリズムを作る
   - 箇条書きと文章のバランスを取る
   - 視覚的な区切り（見出し、引用、リスト）を適切に配置
   - 読者が「もう少し読みたい」と思う展開

■ 充実したコンテンツ構成（15セクション以上・20,000文字）

1. 導入（インパクトあるオープニング）- 600-800字
   - 衝撃的な事実やデータで読者の注意を引く
   - 読者が抱える課題への深い共感を示す
   - この記事を読むことで得られる5つの価値を明示
   - 記事の全体像と読了時間の目安を提示

2. なぜ今この話題なのか - 1000-1200字
   - トピックの緊急性と重要性を説明
   - 最近起きた象徴的な出来事
   - 「知らないと損する」理由を具体的に

3. 背景と歴史的文脈 - 1000-1200字
   - トピックの歴史と進化
   - 過去から現在への変化のストーリー
   - 現在の状況を形作った要因

4. 現状の深掘り分析 - 1200-1500字
   - データと統計で現状を可視化
   - 業界の主要プレイヤーと動向
   - 地域・国際的な比較

5. 本質的な課題の解明 - 1200-1500字
   - 表面的ではない根本的な問題
   - 構造的な原因の分析
   - 当事者の声やリアルな体験談

6. 今週の最新ニュース・動向 - 1500-1800字
   - 直近7日間の重要ニュース3-5件の詳細
   - 各ニュースの意味と影響
   - 今後への示唆

7. 専門家の見解と研究結果 - 1200-1500字
   - 複数の専門家の意見を引用
   - 最新の学術研究の紹介
   - 異なる視点や議論も公平に紹介

8. 驚きの事実・意外なデータ - 800-1000字
   - 「知っていましたか?」形式の新発見
   - 常識を覆すデータや調査結果
   - 読者の「なるほど」を引き出す洞察

9. 基礎から学ぶ入門ガイド - 1200-1500字
   - 初心者向けの基本概念説明
   - 専門用語のわかりやすい解説
   - 最初の一歩として何をすべきか

10. 実践ガイド：ステップバイステップ - 1500-1800字
    - 具体的な行動手順を詳細に解説
    - 各ステップでの注意点とコツ
    - 必要なツールやリソースの紹介

11. 中級・上級者向けテクニック - 1200-1500字
    - より高度な活用法
    - プロが実践しているコツ
    - 効率化や最適化のヒント

12. 成功事例・ケーススタディ - 1500-1800字
    - 5つ以上の具体的な成功事例
    - 各事例の状況・施策・結果を詳述
    - 読者が応用できるポイント

13. 失敗から学ぶ：避けるべき落とし穴 - 1000-1200字
    - 典型的な失敗パターン5つ以上
    - 各失敗の原因と対策
    - 先人の教訓を活かす方法

14. ツールとリソース完全ガイド - 1000-1200字
    - おすすめツール10選（無料・有料別）
    - 各ツールの特徴と使い分け
    - 参考サイト・書籍・コミュニティ

15. 未来予測と準備すべきこと - 1000-1200字
    - 1年後・3年後・5年後の展望
    - これから必要になるスキル
    - 今から始めるべき準備

16. Q&A：よくある質問と回答 - 800-1000字
    - 読者が抱きやすい疑問10個
    - 専門家による明確な回答
    - 追加で知りたい場合の案内

17. まとめと行動計画 - 1000-1200字
    - 記事の要点を7つに凝縮
    - 今日やる・今週やる・今月やるリスト
    - 次のステップへの明確な誘導
    - 読者へのエールと期待

■ SEO最適化

1. タイトル
   - 検索意図に合致したキーワードを自然に含める
   - クリックしたくなる具体的なベネフィットを示す
   - 「2025年最新」「専門家が解説」など時事性・権威性を示す

2. 見出し（H2/H3）
   - 検索されやすいキーワードを含める
   - 質問形式も効果的（例: 「なぜ〜なのか」「〜する方法」）
   - スキャンリーダーにも内容が伝わるように

3. メタディスクリプション
   - 120字以内で記事の価値を凝縮
   - 検索結果でクリックしたくなる内容
"""


def extract_sources_text(sources: list) -> str:
    """
    ソースリストからMarkdown形式のハイパーリンクテキストを生成

    Args:
        sources: ソース情報のリスト

    Returns:
        Markdown形式のソーステキスト（ハイパーリンク付き）
    """
    if not sources:
        return "（調査結果から適切な参考文献を記載してください）"

    sources_list = []
    seen_urls = set()  # 重複URL防止

    for source in sources:
        if isinstance(source, dict):
            title = source.get('title', '').strip()
            url = source.get('url', source.get('uri', '')).strip()

            if url:
                # URLが完全形式でない場合は補完
                if not url.startswith('http'):
                    url = f"https://{url}"

                # 重複チェック
                if url in seen_urls:
                    continue
                seen_urls.add(url)

                # タイトルがない場合はURLからドメイン名を抽出
                if not title:
                    try:
                        from urllib.parse import urlparse
                        parsed = urlparse(url)
                        title = parsed.netloc or url
                    except:
                        title = url

                # Markdown ハイパーリンク形式
                sources_list.append(f"- [{title}]({url})")

        elif isinstance(source, str):
            source = source.strip()
            if source.startswith('http') and source not in seen_urls:
                seen_urls.add(source)
                sources_list.append(f"- [{source}]({source})")
            elif source and source not in seen_urls:
                # URLなしのテキストソースは除外（ハイパーリンクにできないため）
                pass

    if not sources_list:
        return "（URLを含む参考文献が見つかりませんでした）"

    return "\n".join(sources_list)


async def generate_article(topic_id: str, research_data: dict) -> dict:
    """
    記事を生成（7日以内最新情報 & 引用元必須）

    Args:
        topic_id: トピックID
        research_data: 調査データ（sources, date_range含む）

    Returns:
        生成された記事データ（引用元セクション含む）
    """
    client = GeminiClient()

    topic_info = research_data.get('topic_info', {})
    today = format_date()  # JST date

    # リサーチ日付範囲を取得
    date_range = research_data.get('date_range', {})
    start_date = date_range.get('start', '')
    end_date = date_range.get('end', today)
    research_date = research_data.get('research_date', today)

    # ソース情報を抽出（必須）
    sources = research_data.get('sources', [])
    sources_text = extract_sources_text(sources)
    sources_count = len(sources)

    # トピック別のライティング指示
    topic_writing_tips = {
        "psychology": "読者のメンタルヘルスに寄り添う温かみのある文体で。具体的なセルフケア方法を提示する。",
        "education": "教育現場で実践できる具体的なヒントを含める。保護者と教育者両方の視点を意識する。",
        "startup": "起業を検討している読者に勇気を与えつつ、リスクも現実的に伝える。成功・失敗両方の事例を。",
        "investment": "初心者にもわかりやすく。リスクについて必ず言及する。具体的な数値と制度の説明を。",
        "ai_tools": "実際に使える具体的なツールや活用法を紹介。技術的な内容も噛み砕いて説明する。",
        "inclusive_education": "当事者や保護者の気持ちに寄り添う。具体的な支援制度や相談先を紹介する。",
        "weekly_summary": "1週間の動向を俯瞰的に整理。各分野のつながりや傾向を分析する。"
    }
    writing_tip = topic_writing_tips.get(topic_id, "読者にとって実践的で価値のある情報を提供する。")

    prompt = f"""
あなたは{topic_info.get('name', topic_id)}分野の専門知識を持つプロのブログライターです。
以下の調査結果を基に、**読者が「読んでよかった」と思える高品質なブログ記事**を執筆してください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【基本情報】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- 本日: {research_date}
- トピック: {topic_info.get('name', topic_id)}
- ターゲット読者: {topic_info.get('target_audience', '一般読者')}
- 調査期間: {start_date}〜{end_date}（7日以内の最新情報のみ使用）
- 参考ソース数: {sources_count}件

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【調査結果（これを基に記事を執筆）】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{research_data.get('content', '')}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【参考文献・引用元（記事末尾に必ず記載）】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{sources_text}

{DESIGN_GUIDELINES}

{QUALITY_GUIDELINES}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【このトピック特有の執筆ポイント】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
{writing_tip}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【記事構成の必須要件 - 5倍ボリューム版】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**重要**: 従来の5倍以上のボリューム（20,000文字以上）で執筆すること

1. 導入（インパクトあるオープニング）- 600-800字
   - 衝撃的な事実やデータで読者の注意を引く
   - 読者が抱える課題への深い共感を示す
   - この記事を読むことで得られる5つの価値を明示
   - 記事の全体像と読了時間の目安を提示

2. 本文（15セクション以上）- 各1000-1500字
   - 各セクションで1つの明確なポイントを深掘り
   - 具体的なデータ、事例、専門家の見解を必ず含める
   - 抽象的な説明の後に必ず具体例を5つ以上示す
   - 「〇〇の調査によると」「△△の専門家は」と根拠を明記
   - 各セクションにH3サブ見出しを3-5個設ける
   - 読者への問いかけを適度に配置
   - 「知っていましたか?」形式の驚きの情報を含める

3. Q&Aセクション - 800-1000字
   - 読者が抱きやすい質問を10個以上
   - 各質問に具体的で実用的な回答

4. まとめ - 1000-1200字
   - 記事の要点を7つ以上に凝縮
   - 今日・今週・今月のアクションプラン
   - 次のステップへの明確な誘導
   - 読者へのエールと期待

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【品質チェックリスト（執筆後に確認）】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 文字数: 20,000-25,000文字（従来の5倍以上）
□ H2見出し: 12-18個
□ H3サブ見出し: 合計40個以上
□ 絵文字を一切使用していないか
□ 具体的な数値・データを最低25箇所以上含めたか
□ 各主張に根拠（ソース）を明記したか
□ 成功事例を5つ以上、失敗事例を3つ以上含めたか
□ 読者が実践できる具体的なアクションを10個以上示したか
□ 7日より古い情報を含めていないか
□ 専門用語は初出時に必ず説明したか
□ 各セクションに十分な内容（1000-1500字）があるか
□ 初心者・中級者・上級者向けの情報を分けて記載したか
□ 読者への問いかけを5箇所以上含めたか
□ 「知っていましたか?」形式の驚きの情報を3つ以上含めたか
□ ストーリー性のある事例を2つ以上含めたか
□ Q&Aセクションに10個以上の質問と回答があるか

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【出力形式 - 充実版】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Markdown形式で以下の構造で出力してください:

---
layout: post
title: "タイトル（具体的でSEOを意識、絵文字なし、60文字以内）"
description: "メタディスクリプション（この記事で得られる価値を凝縮、120文字以内）"
date: {today}
categories: [{topic_info.get('name', topic_id)}]
tags: [関連性の高いタグを5-8個]
author: "AI Blog Generator"
---

【リード文】読者の課題や関心に寄り添う導入。衝撃的な数値や事実で始める。この記事で得られる3つの価値を明示。（400-500字）

## 1. このトピックが今注目される理由

現在の状況を説明し、なぜ今このトピックが重要なのかを解説。（600-800字）

### 背景にある社会的変化

詳細な説明（200-300字）

### 数字で見る現状

具体的なデータと統計（200-300字）

## 2. 基礎知識：押さえておくべき重要概念

初心者にもわかりやすく基礎を解説。（600-800字）

### 基本的な定義と用語解説

専門用語をわかりやすく解説

### よくある誤解と正しい理解

誤解されやすいポイントを訂正

## 3. 最新トレンド：今週の重要ニュース

今週起きた重要なニュースや動向を詳細に紹介。（800-1000字）

### 注目ニュース1

詳細と影響の分析

### 注目ニュース2

詳細と影響の分析

### 業界全体の動向

傾向と分析

## 4. 専門家の見解と研究結果

複数の専門家の意見と最新の研究結果。（600-800字）

### 専門家Aの見解

具体的な引用と解説

### 最新研究からわかったこと

研究結果の紹介

## 5. 実践ガイド：具体的な方法とステップ

読者がすぐに実践できる具体的な方法。（1000-1200字）

### 初心者向け：最初の一歩

ステップバイステップの解説

### 中級者向け：効果を高めるコツ

より効果的な実践方法

### 上級者向け：応用テクニック

高度な活用法

## 6. 成功事例に学ぶ：ケーススタディ

実際の成功事例を3つ以上詳細に紹介。（800-1000字）

### 事例1: [具体的な事例名]

状況、取り組み、結果の詳細

### 事例2: [具体的な事例名]

状況、取り組み、結果の詳細

### 事例3: [具体的な事例名]

状況、取り組み、結果の詳細

## 7. 失敗から学ぶ：避けるべき落とし穴

よくある失敗パターンと対策。（600-800字）

### 失敗パターン1

原因と対策

### 失敗パターン2

原因と対策

## 8. ツールとリソース：活用できる便利な情報

具体的なツールやリソースの紹介。（600-800字）

### おすすめツール3選

各ツールの特徴と使い方

### 情報収集に役立つリソース

参考になるサイトや書籍

## 9. 今後の展望：これからどうなるか

業界の将来予測と準備すべきこと。（600-800字）

### 短期的な見通し（3ヶ月以内）

近い将来の動向

### 中長期的な展望（1年以上）

長期的なトレンド

## 10. まとめ：今日から始める5つのアクション

記事の要点を振り返り、段階的なアクションプランを提示。（600-800字）

今回の記事で解説した内容を実践するために、以下の5つのアクションを段階的に実行してください：

### 今日やること

1. **アクション1**: 具体的な行動指針と期待される効果

### 今週やること

2. **アクション2**: 具体的な行動指針と期待される効果
3. **アクション3**: 具体的な行動指針と期待される効果

### 今月やること

4. **アクション4**: 具体的な行動指針と期待される効果
5. **アクション5**: 具体的な行動指針と期待される効果

---

## 参考文献・引用元

この記事は以下の情報源を参考に作成されました（{start_date}〜{end_date}の調査に基づく）：

**重要**: 必ず以下の形式でハイパーリンクを記載してください：
- [記事タイトル](https://完全なURL)

{sources_text}

---

*この記事は{research_date}時点の情報に基づいて作成されました。最新情報は各公式サイトでご確認ください。*
"""

    result = await client.generate_content(
        prompt=prompt,
        model=GeminiClient.MODEL_PRO,
        enable_search=True,
        temperature=0.7
    )

    content = result.text

    # 絵文字を除去（安全策として）
    emoji_pattern = re.compile(
        "["
        "\U0001F600-\U0001F64F"  # emoticons
        "\U0001F300-\U0001F5FF"  # symbols & pictographs
        "\U0001F680-\U0001F6FF"  # transport & map symbols
        "\U0001F1E0-\U0001F1FF"  # flags
        "\U00002702-\U000027B0"
        "\U000024C2-\U0001F251"
        "]+",
        flags=re.UNICODE
    )
    content = emoji_pattern.sub('', content)

    # 引用元セクションが含まれているか確認
    if "参考文献・引用元" not in content and sources:
        # 引用元セクションがない場合は追加
        sources_section = f"""

---

## 参考文献・引用元

<div class="sources-section">

この記事は以下の情報源を参考に作成されました（{start_date}〜{end_date}の調査に基づく）：

{sources_text}

</div>

---

*この記事はAIによって生成されました。情報は{research_date}時点のものです。*
"""
        content = content.rstrip() + sources_section

    # タイトルを抽出
    title_match = re.search(r'title:\s*["\']?(.+?)["\']?\s*\n', content)
    title = title_match.group(1) if title_match else f"{topic_info.get('name', topic_id)}に関する最新情報"

    # descriptionを抽出
    desc_match = re.search(r'description:\s*["\']?(.+?)["\']?\s*\n', content)
    description = desc_match.group(1) if desc_match else ""

    # tagsを抽出
    tags_match = re.search(r'tags:\s*\[([^\]]+)\]', content)
    tags = []
    if tags_match:
        tags_str = tags_match.group(1)
        # タグを分割してクリーンアップ
        tags = [tag.strip().strip('"\'') for tag in tags_str.split(',') if tag.strip()]

    return {
        "topic": topic_id,
        "title": title,
        "description": description,
        "content": content,
        "word_count": len(content),
        "categories": [topic_info.get('name', topic_id)],
        "tags": tags,
        "sources": sources,
        "research_date": research_date,
        "date_range": date_range
    }


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Generate blog article with design guidelines")
    parser.add_argument('--topic', required=True, help='Topic ID')
    args = parser.parse_args()

    # Load research data from file or run research
    from research import run_research
    research_data = asyncio.run(run_research(args.topic))
    result = asyncio.run(generate_article(args.topic, research_data))
    print(result['content'])
